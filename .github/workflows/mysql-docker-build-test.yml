name: MySQL Docker 镜像构建测试

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'mysql/**'
      - '.github/workflows/mysql-docker-build-test.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'mysql/**'
      - '.github/workflows/mysql-docker-build-test.yml'
  workflow_dispatch: # 手动触发工作流程
  schedule:
    - cron: '0 0 * * 1' # 每周一 0点（UTC），相当于中国时间每周一凌晨8点

env:
  TZ: Asia/Shanghai
  MYSQL_ROOT_PASSWORD: root
  MYSQL_ROOT_HOST: *
  MYSQL_USER: admin
  MYSQL_PASSWORD: admin

jobs:
  # MySQL 8
  build-mysql-8:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      - name: 准备 compose.yml 文件
        working-directory: mysql/8
        run: |
          cp compose.sample.yml compose.yml
          # 添加 networks 定义到 compose.yml
          echo "" >> compose.yml
          echo "networks:" >> compose.yml
          echo "  docker:" >> compose.yml
          echo "    name: docker" >> compose.yml
          echo "    driver: bridge" >> compose.yml
      - name: 设置环境变量
        working-directory: mysql/8
        run: |
          echo "TZ=${{ env.TZ }}" > .env
          echo "MYSQL_ROOT_PASSWORD=${{ env.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "MYSQL_ROOT_HOST=${{ env.MYSQL_ROOT_HOST }}" >> .env
          echo "MYSQL_USER=${{ env.MYSQL_USER }}" >> .env
          echo "MYSQL_PASSWORD=${{ env.MYSQL_PASSWORD }}" >> .env
      - name: 构建 MySQL 8 镜像
        working-directory: mysql/8
        run: docker compose build --no-cache
      - name: 验证镜像
        working-directory: mysql/8
        run: |
          echo "✅ MySQL 8 镜像构建成功"
          docker compose up -d mysql8
          sleep 20
          docker compose exec mysql8 mysql --version

  # MySQL 9
  build-mysql-9:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      - name: 准备 compose.yml 文件
        working-directory: mysql/9
        run: |
          cp compose.sample.yml compose.yml
          # 添加 networks 定义到 compose.yml
          echo "" >> compose.yml
          echo "networks:" >> compose.yml
          echo "  docker:" >> compose.yml
          echo "    name: docker" >> compose.yml
          echo "    driver: bridge" >> compose.yml
      - name: 设置环境变量
        working-directory: mysql/9
        run: |
          echo "TZ=${{ env.TZ }}" > .env
          echo "MYSQL_ROOT_PASSWORD=${{ env.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "MYSQL_ROOT_HOST=${{ env.MYSQL_ROOT_HOST }}" >> .env
          echo "MYSQL_USER=${{ env.MYSQL_USER }}" >> .env
          echo "MYSQL_PASSWORD=${{ env.MYSQL_PASSWORD }}" >> .env
      - name: 构建 MySQL 9 镜像
        working-directory: mysql/9
        run: docker compose build --no-cache
      - name: 验证镜像
        working-directory: mysql/9
        run: |
          echo "✅ MySQL 9 镜像构建成功"
          docker compose up -d mysql9
          sleep 20
          docker compose exec mysql9 mysql --version
